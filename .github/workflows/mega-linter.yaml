# MegaLinter GitHub Action
# https://megalinter.io/latest/

name: MegaLinter

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write
  statuses: write

jobs:
  megalinter:
    name: MegaLinter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full git history for better analysis

      - name: MegaLinter
        id: ml
        uses: oxsecurity/megalinter@v8
        env:
          VALIDATE_ALL_CODEBASE: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Override settings for CI
          APPLY_FIXES: none
          DISABLE_ERRORS: false

      # Upload reports as artifacts
      - name: Archive linting reports
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: MegaLinter-reports
          path: |
            megalinter-reports
            mega-linter.log
          retention-days: 7

      # Add PR comment with summary (only on PRs)
      - name: Create PR comment
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'megalinter-reports/megalinter-report.txt';

            if (!fs.existsSync(reportPath)) {
              console.log('No report file found');
              return;
            }

            const report = fs.readFileSync(reportPath, 'utf8');
            const status = '${{ steps.ml.outcome }}' === 'success' ? 'âœ…' : 'âŒ';

            // Truncate if too long
            const maxLength = 65000;
            const truncatedReport = report.length > maxLength
              ? report.substring(0, maxLength) + '\n\n... (truncated)'
              : report;

            const body = `## ${status} MegaLinter Report

            <details>
            <summary>Click to expand full report</summary>

            \`\`\`
            ${truncatedReport}
            \`\`\`

            </details>

            ðŸ“Š Full reports available in [workflow artifacts](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
